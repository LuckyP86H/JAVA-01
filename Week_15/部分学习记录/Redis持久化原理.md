# Redis持久化原理

## 为什么要持久化？

将内存中的数据存储到硬盘的一个原因是为了在之后重用数据，或者是为了防止系统故障而将数据备份到一个远程的位置。另外，存储在redis里面的数据有可能是经过长时间计算得出的，或者有程序正在使用redis存储的数据进行计算。

Redis提供了两种不同的持久化方法来讲数据存储到硬盘里面。

## 分类

一种叫做快照（Redis Database），一种是AOF（Append Only-file）叫做只追加文件。

### 快照

Redis可以通过创建快照来获得存储在内存里面的数据在某个时间点的上的副本。在创建快照之后，用户可以对快照进行备份，可以将快照复制到其他的服务器从而创建具有相同数据的服务器副本，还可以将快照留在原地以便重启服务器的时候使用。

如果在新的快照文件创建完毕之前，Redis、系统或者硬件这三者之中任意一个崩溃了，那么redis将会丢失最后一次创建快照之后写入的所有的数据。

#### 创建快照的方式

##### BGSAVE 

客户端可以通过向Redis发送BGSAVE命令来创建一个快照。

对于一个支持BGSAVE命令的平台来说，Redis会调用fork来创建一个子进程，然后子进程负责将快照写入硬盘，而父进程继续处理命令请求。

当一个Redis服务器连接另一个Redis服务器，并向对方发送sync命令来开始一次复制操作的时候，如果主服务器目前没有在执行BGSAVE操作，或者主服务器并非刚刚执行完BGSAVE操作，那么主服务器就会执行BGSAVE命令。

##### SAVE

客户端还可以通过向Redis发送SAVE命令来创建一个快照。

接到SAVE命令的Redis服务器在快照创建完毕之前将不再响应任何其他的命令。

注意：SAVE命令并不常用，我们通常只会在没有足够内存区执行BGSAVE命令的情况下，又或者是即使是等待持久化操作执行完毕也无所谓的情况下，才会使用这个命令。

当Redis通过shutdown命令接收到关闭服务器的请求时，或者接收到标准term信号时，会执行一个save命令，阻塞所有的客户端，不在执行客户端发送的任何命令，并在save命令执行完毕后关闭服务器。

> 在只使用快照持久化来保存数据时，如果真的发生崩溃，用户将会丢失最后一次生成快照之后更改的所有的数据。
>
> 快照持久化只适用于哪些即便丢失掉一部分数据也不会造成问题的应用程序。

### AOF

AOF持久化会将被执行的写命令写到AOF文件的末尾，以此来记录数据发生的变化。因此，Redis只要从头到尾重新执行一遍AOF文件包含的所有写命令，就可以恢复AOF文件所记录的数据集。

##### 文件同步

在向硬盘写入文件的时候，至少会发生三件事情：

1、当调用**file.write()**方法对文件进行写入时，写入的内容首先会被**存储到缓冲区**。然后操作系统会在将来的**某个时候**将缓冲区存储的内容写入硬盘。数据只有在被写入硬盘之后才可以算是真正保存到了硬盘里面。

2、用户可以通过**file.flush()**方法来**请求操作系统**尽快将缓冲区存储的数据写入到硬盘里面，具体何时写到操作系统需要由操作系统来决定。

3、用户可以命令操作系统将文件同步到sync到硬盘，同步操作会一直阻塞到指定的文件写入硬盘位置。当操作系统执行完毕后，故障也不会堆被同步的文件造成影响。

##### appendfsync同步策略

###### always ：redis每次写命令都要同步写入硬盘，这样做会降低redis的速度

如果用户使用  **always** 选项的话，那么**每个 Redis 写命令都会被写入硬盘**，从而将发生系统崩溃时出现的**数据丢失减到最少**。不过遗憾的是，因为这种同步策略需要对硬盘进行大量写入，所以 Redis 处理命令的速度会受到硬盘性能的限制∶转盘式硬盘在这种同步频率下每秒只能处理大约 200个写命令，而固态硬盘每秒大概也只能处理几万个写命令。  

警告∶使用固态硬盘的用户请谨慎使用 always 选项，因为这个选项让 Redis 每次只写入一个命令，而不是像其他选项那样一次写入多个命令，这种不断地写入少量数据的做法有可能会引发严重的写入放大问题，在某些情况下甚至会将固态硬盘的寿命从原来的几年降低为几个月。  

###### everysec：每秒执行一次同步，显示的将多个命令同步到硬盘

为了兼顾数据安全和写入性能，用户可以考虑使用 everysec选项，让 Redis以每秒一次的频率对 AOF 文件进行同步。Redis 每秒同步一次 AOF 文件时的性能和不使用任何持久化特性时的性能相差无几，而通过每秒同步一次 AOF 文件，Redis 可以保证，即使出现系统崩溃，用户也最多只会丢失一秒之内产生的数据。

当硬盘忙于执行写入操作的时候，Redis 还会优雅地放慢自己的速度以便适应硬盘的最大写入速度。 



##### no：由操作系统决定因该何时同步

如果用户使用 appendfsync no 选项，那么 Redis 将不对 AOF 文件执行任何显式的同步操作，而是由操作系统来决定应该在何时对 AOF 文件进行同步。这个选项在一般情况下不会对 Redis 的性能带来影响，但系统崩溃将导致使用这种选项的 Redis 服务器丢失不定数量的数据。另外，如果用户的硬盘处理写入操作的速度不够快的话，那么当缓冲区被等待写入硬盘的数据填满时，Redis 的写入操作将被阻塞，并导致 Redis 处理命令请求的速度变慢。因为这个原因，一般来说并不推荐使用 no 选项。  









